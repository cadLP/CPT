
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>cpt.spiders.Wiwo &#8212; CPT 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cpt.spiders.Wiwo</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: Wiwo</span>
<span class="sd">    :synopsis: Spider for extracting data from wirtschaftswoche</span>

<span class="sd">.. moduleauthor:: Lydia Wepner &lt;s2lywepn@uni-trier.de&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">scrapy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">..items</span> <span class="k">import</span> <span class="n">CptItem</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>

<div class="viewcode-block" id="WiwoSpider"><a class="viewcode-back" href="../../../index.html#cpt.spiders.Wiwo.WiwoSpider">[docs]</a><span class="k">class</span> <span class="nc">WiwoSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class creates the Spider for the crawler of the Wirtschaftswoche.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Politik&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;https://www.wiwo.de/politik/&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Wirtschaft&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;https://www.wiwo.de/finanzen/&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.wiwo.de/unternehmen/&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Gesellschaft&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;https://www.wiwo.de/erfolg/trends/&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.wiwo.de/technologie/green/&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Technik&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;https://www.wiwo.de/technologie/&quot;</span><span class="p">},</span>
        <span class="s2">&quot;IT&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;https://www.wiwo.de/unternehmen/it/&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.wiwo.de/technologie/digitale-welt/&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Wissen&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;https://www.wiwo.de/unternehmen/energie/&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.wiwo.de/technologie/umwelt/&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;https://www.wiwo.de/technologie/forschung/&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Karriere&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;https://www.wiwo.de/erfolg/&quot;</span><span class="p">,</span> <span class="s2">&quot;https://www.wiwo.de/erfolg/hochschule/&quot;</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Politik&quot;</span><span class="p">,</span> <span class="s2">&quot;Wirtschaft&quot;</span><span class="p">,</span> <span class="s2">&quot;Gesellschaft&quot;</span><span class="p">,</span> <span class="s2">&quot;Technik&quot;</span><span class="p">,</span> <span class="s2">&quot;IT&quot;</span><span class="p">,</span> <span class="s2">&quot;Wissen&quot;</span><span class="p">,</span> <span class="s2">&quot;Karriere&quot;</span><span class="p">]</span>
    <span class="c1">#selected_cat = [&quot;Wirtschaft&quot;]</span>

    <span class="n">selected_categories</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_categories</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">existing_urls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat_list</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All categories are stored in a dictionary. Here this dictionary will be converted into a list of all relevant</span>
<span class="sd">        URLs.</span>
<span class="sd">        :param cat_list: A list of the categories that should be scraped.</span>
<span class="sd">        :type cat_list: list</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WiwoSpider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cat_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selected_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;postgres&quot;</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="s2">&quot;cpt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT url FROM metadaten;&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">existing_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Wiwo&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;www.wiwo.de&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="n">selected_categories</span>

<div class="viewcode-block" id="WiwoSpider.parse"><a class="viewcode-back" href="../../../index.html#cpt.spiders.Wiwo.WiwoSpider.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In this function we extract the links to the subcategories based on the start url page and follow each link</span>
<span class="sd">        to the subcategories the x-path expression finds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">link_selector</span> <span class="o">=</span> <span class="s2">&quot;//h2[contains(@class,&#39;ressort&#39;)]/a/@href&quot;</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">link_selector</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">wiwo_index</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">link_selector</span><span class="p">)</span><span class="o">.</span><span class="n">getall</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">wiwo_index</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_categories</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">wiwo_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsecontent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsecontent</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">request</span></div>

<div class="viewcode-block" id="WiwoSpider.parsecontent"><a class="viewcode-back" href="../../../index.html#cpt.spiders.Wiwo.WiwoSpider.parsecontent">[docs]</a>    <span class="k">def</span> <span class="nf">parsecontent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called after the parse function and we extract and follow the links of each article</span>
<span class="sd">        using an x-path expression which loops over the several subcategories. In case the subcategory has more</span>
<span class="sd">        than one page of articles, an x-path expression follows the link to the next page and extracts the</span>
<span class="sd">        articles from there.</span>
<span class="sd">        :param response: A Response object represents an HTTP response, which is usually downloaded (by the Downloader) and fed to the Spiders for processing</span>
<span class="sd">        :type response: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">link_selector</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//a[contains(@class, &quot;teaser__image-wrapper&quot;)]/@href&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getall</span><span class="p">()</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//a[contains(@rel,&quot;next&quot;)]/@href&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">next_page</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">next_page</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsecontent</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">link_selector</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsearticle</span><span class="p">)</span></div>

<div class="viewcode-block" id="WiwoSpider.parsearticle"><a class="viewcode-back" href="../../../index.html#cpt.spiders.Wiwo.WiwoSpider.parsearticle">[docs]</a>    <span class="k">def</span> <span class="nf">parsearticle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function collects all relevant article information to store in the database. All articles (except</span>
<span class="sd">        picture galleries, in which we are not interested) contains an ld+json object in their source code. This</span>
<span class="sd">        object contains the majority of data we are looking for (including date_published, date_modified, author,</span>
<span class="sd">        publisher, images and keywords). For the images we only store the corresponding link. If there are several</span>
<span class="sd">        authors, publishers, images or keywords we convert the given list into a string. The title is extracted directly</span>
<span class="sd">        from the source code. The article body is combined of the several paragraphs extracted by a x-path expression. To</span>
<span class="sd">        avoid losing information included in the text linked to another page we remove the HTML-tags and substitute them</span>
<span class="sd">        with &quot;&quot; using a regular expression. The category is chosen falling back on the dictionary &#39;categories&#39; and</span>
<span class="sd">        for articles in subcategory not consistently following main category the longest link will be chosen.</span>
<span class="sd">        The metadata will be written into a scrapy item element.</span>
<span class="sd">        To reveal the payment status of the article we follow a x-path expression and scrape only the</span>
<span class="sd">        articles, which are freely accessible. Some articles are divided into more than one page. If this is tha case</span>
<span class="sd">        we follow the link to the button &quot;Artikel auf einer Seite&quot; and the whole content will be shown on one page,</span>
<span class="sd">        which we scrape like one-page articles and the item element will be the end result.</span>
<span class="sd">        :param response: A Response object represents an HTTP response, which is usually downloaded (by the Downloader)</span>
<span class="sd">        and fed to the Spiders for processing</span>
<span class="sd">        :type response: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;url: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">CptItem</span><span class="p">()</span>

        <span class="n">metadata_selektor</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//script[contains(@type, &quot;ld+json&quot;)]/text()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">premium</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[contains(@class, &quot;c-metadata--premium&quot;)]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">one_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//a[contains(@data-command,&quot;Paginierung-Artikel-auf-einer-Seite&quot;)]/@href&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">one_page</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">one_page</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">one_page</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsearticle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">premium</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metadata_selektor</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metadata_selektor</span><span class="p">)</span>

                    <span class="n">title</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;headline&quot;</span><span class="p">]</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">date_published</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;datePublished&quot;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">date_published</span> <span class="o">=</span> <span class="s2">&quot;no date&quot;</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">date_modified</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;dateModified&quot;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">date_modified</span> <span class="o">=</span> <span class="s2">&quot;no date&quot;</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">authors</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">author_str</span> <span class="o">=</span> <span class="s2">&quot;no author&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">author_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">authors</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">author_str</span><span class="p">:</span>
                                    <span class="n">author_str</span> <span class="o">+=</span> <span class="n">author</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">author_str</span> <span class="o">=</span> <span class="n">author_str</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">author</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">author_str</span> <span class="o">+=</span> <span class="n">authors</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">publishers</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">publisher_str</span> <span class="o">=</span> <span class="s2">&quot;no publisher&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">publisher_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">publishers</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">publisher</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">publisher_str</span><span class="p">:</span>
                                    <span class="n">publisher_str</span> <span class="o">+=</span> <span class="n">publisher</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">publisher_str</span> <span class="o">=</span> <span class="n">publisher_str</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">publisher</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">publisher_str</span> <span class="o">+=</span> <span class="n">publishers</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">images</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">image_str</span> <span class="o">=</span> <span class="s2">&quot;no image&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">image_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">image_str</span><span class="p">:</span>
                                    <span class="n">image_str</span> <span class="o">+=</span> <span class="n">image</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">image_str</span> <span class="o">=</span> <span class="n">image_str</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">image_str</span> <span class="o">+=</span> <span class="n">images</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">keywords</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">keywords_str</span> <span class="o">=</span> <span class="s2">&quot;no keywords&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">keywords_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords_str</span><span class="p">:</span>
                                    <span class="n">keywords_str</span> <span class="o">+=</span> <span class="n">keyword</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">keywords_str</span> <span class="o">=</span> <span class="n">keywords_str</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">keyword</span>

                    <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[contains(@class, &quot;u-richtext&quot;)]/p&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getall</span><span class="p">()</span>
                    <span class="n">body_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">body_str</span><span class="p">:</span>
                            <span class="n">body_str</span> <span class="o">+=</span> <span class="n">p</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">body_str</span> <span class="o">=</span> <span class="n">body_str</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">p</span>
                    <span class="n">body_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&lt;[^&gt;]+?&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">body_str</span><span class="p">)</span>

                    <span class="n">temp_max</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span><span class="n">temp_max</span><span class="p">:</span>
                                <span class="n">temp_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">category</span> <span class="o">=</span> <span class="n">key</span>
                                <span class="n">category</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>

                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">author_str</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;date_published&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_published</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;date_edited&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_modified</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keywords_str</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_str</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;german&quot;</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;article_text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">body_str</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">items</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Wirtschaftswoche&quot;</span>

                    <span class="k">yield</span> <span class="n">items</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">CPT</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Tristan Dietz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>